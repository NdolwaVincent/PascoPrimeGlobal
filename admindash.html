<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Pasco Prime Global - Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex h-screen bg-gray-100">

  <!-- Sidebar -->
  <aside class="w-64 bg-indigo-800 text-white flex flex-col">
    <div class="p-6 text-center border-b border-indigo-700">
      <h2 class="text-2xl font-bold">Admin Panel</h2>
    </div>
    <nav class="flex-1 p-4 space-y-2">
      <a href="#" data-section="dashboard" class="block px-4 py-2 rounded hover:bg-indigo-700">Users</a>
      <a href="#" data-section="packages" class="block px-4 py-2 rounded hover:bg-indigo-700">Packages</a>
      <a href="#" data-section="withdr" class="block px-4 py-2 rounded hover:bg-indigo-700">Withdrawals</a>
    </nav>
    <div class="p-4 border-t border-indigo-700">
      <a href="pay.html" target="_blank" class="block text-center bg-blue-600 hover:bg-blue-700 py-2 rounded text-white">Dev Page</a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col overflow-y-auto">
    <!-- Header -->
    <header class="bg-indigo-800 text-white flex justify-between items-center px-6 py-3 shadow">
      <h1 id="dashboard-title" class="text-lg font-semibold">Dashboard</h1>
      <button class="bg-red-500 hover:bg-red-600 px-4 py-1 rounded">Logout</button>
    </header>

    <!-- Dashboard (Users Section) -->
    <section id="dashboard" class="section p-6">
      <h2 class="text-2xl font-bold mb-4">PASCO PRIME GLOBAL ADMIN DASHBOARD</h2>

      <div class="mb-4">
        <input id="searchInput" type="text" placeholder="Search by username..."
               class="w-full max-w-md border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-300" />
      </div>

      <div class="h-1 bg-gray-300 mb-4">
        <div id="progressBar" class="h-1 bg-green-500 w-0 transition-all duration-500"></div>
      </div>

      <div class="overflow-x-auto bg-white shadow-md rounded-lg">
        <table class="min-w-full text-sm text-gray-700">
          <thead class="bg-indigo-600 text-white">
            <tr>
              <th class="px-4 py-2">No</th>
              <th class="px-4 py-2">Username</th>
              <th class="px-4 py-2">Phone</th>
              <th class="px-4 py-2">Deposit</th>
              <th class="px-4 py-2">Balance</th>
              <th class="px-4 py-2">Account</th>
              <th class="px-4 py-2">Withdraw</th>
              <th class="px-4 py-2">Referred By</th>
              <th class="px-4 py-2">Email</th>
              <th class="px-4 py-2">Password</th>
              <th class="px-4 py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="users-container"></tbody>
        </table>
      </div>
    </section>

    <!-- Packages Section -->
    <section id="packages" class="section hidden p-6">
      <h2 class="text-2xl font-bold mb-4">Manage Packages</h2>

      <div class="bg-white shadow-md rounded-lg p-6 mb-6 max-w-lg">
        <form id="packageForm" class="space-y-4">
          <div>
            <label class="block mb-1 font-semibold">Username</label>
            <select id="username" class="w-full border border-gray-300 rounded px-3 py-2" required>
              <option value="" disabled selected>Select a username</option>
            </select>
          </div>

          <div>
            <label class="block mb-1 font-semibold">Package Name</label>
            <select id="packageName" class="w-full border border-gray-300 rounded px-3 py-2" required>
              <option value="Global-Elite">PP GLOBAL ELITE</option>
              <option value="Global-Premier">PP GLOBAL PREMIER</option>
              <option value="Global-Executive">PP GLOBAL EXECUTIVE</option>
              <option value="Global-Platinum">PP GLOBAL PLATINUM</option>
              <option value="Global-Titanium">PP GLOBAL TITANIUM</option>
              <option value="Global-Diamond">PP GLOBAL DIAMOND</option>
              <option value="Global-Sovereign">PP GLOBAL SOVEREIGN</option>
              <option value="Global-Prestige">PP GLOBAL PRESTIGE</option>
              <option value="Global-Royal">PP GLOBAL ROYAL</option>
              <option value="Global-Imperial">PP GLOBAL IMPERIAL</option>
            </select>
          </div>

          <div>
            <label class="block mb-1 font-semibold">Daily Earnings</label>
            <input type="number" id="dailyEarnings" class="w-full border border-gray-300 rounded px-3 py-2" required />
          </div>

          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full">Save Package</button>
        </form>
        <p id="statusMessage" class="text-blue-600 mt-3 text-center font-semibold"></p>
        <div id="loadingBar" class="h-1 bg-green-500 w-0 transition-all duration-500 mt-2"></div>
      </div>

      <div class="overflow-x-auto bg-white shadow-md rounded-lg">
        <table class="min-w-full text-sm text-gray-700" id="packagesTable">
          <thead class="bg-indigo-600 text-white">
            <tr>
              <th class="px-4 py-2">Username</th>
              <th class="px-4 py-2">Package Name</th>
              <th class="px-4 py-2">Daily Earnings</th>
              <th class="px-4 py-2">Date</th>
              <th class="px-4 py-2">Time</th>
              <th class="px-4 py-2">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Withdrawals Section -->
    <section id="withdr" class="section hidden p-6">
      <h2 class="text-2xl font-bold mb-4">Withdrawal Requests</h2>

      <h3 class="font-semibold mb-2">Unseen Requests</h3>
      <div class="overflow-x-auto bg-white shadow-md rounded-lg mb-6">
        <table class="min-w-full text-sm text-gray-700">
          <thead class="bg-indigo-600 text-white">
            <tr>
              <th class="px-4 py-2">Username</th>
              <th class="px-4 py-2">Wallet</th>
              <th class="px-4 py-2">Amount (USD)</th>
              <th class="px-4 py-2">Timestamp</th>
              <th class="px-4 py-2">Action</th>
            </tr>
          </thead>
          <tbody id="unseenTable"></tbody>
        </table>
      </div>

      <h3 class="font-semibold mb-2">Seen Requests</h3>
      <div class="overflow-x-auto bg-white shadow-md rounded-lg">
        <table class="min-w-full text-sm text-gray-700">
          <thead class="bg-indigo-600 text-white">
            <tr>
              <th class="px-4 py-2">Username</th>
              <th class="px-4 py-2">Wallet</th>
              <th class="px-4 py-2">Amount (USD)</th>
              <th class="px-4 py-2">Timestamp</th>
              <th class="px-4 py-2">Action</th>
            </tr>
          </thead>
          <tbody id="seenTable"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- JavaScript Section -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getDatabase, ref, get, update, remove, set, onValue } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD6k4OlLYnotuuChAjLBoHmqfv9-iwrlfY",
      authDomain: "alfajiri-database.firebaseapp.com",
      databaseURL: "https://alfajiri-database-default-rtdb.firebaseio.com",
      projectId: "alfajiri-database",
      storageBucket: "alfajiri-database.appspot.com",
      messagingSenderId: "310417854615",
      appId: "1:310417854615:web:6f65002a119caeaf9119d2",
      measurementId: "G-21TBZCRBHM",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Navigation
    const links = document.querySelectorAll("aside nav a");
    const sections = document.querySelectorAll(".section");
    const title = document.getElementById("dashboard-title");
    links.forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        sections.forEach(sec => sec.classList.add("hidden"));
        document.getElementById(link.dataset.section).classList.remove("hidden");
        title.textContent = link.textContent;
      });
    });

    // Users section
    const usersContainer = document.getElementById("users-container");
    const progressBar = document.getElementById("progressBar");
    const searchInput = document.getElementById("searchInput");

    async function fetchUsers() {
      progressBar.style.width = "50%";
      const snapshot = await get(ref(db, "users"));
      progressBar.style.width = "100%";
      setTimeout(() => (progressBar.style.width = "0%"), 500);

      if (snapshot.exists()) {
        const users = snapshot.val();
        usersContainer.innerHTML = "";
        let i = 1;
        for (const key in users) {
          const u = users[key];
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="px-3 py-2">${i++}</td>
            <td class="px-3 py-2">${u.username || ""}</td>
            <td class="px-3 py-2">${u.phone || ""}</td>
            <td class="px-3 py-2">${u.depo || ""}</td>
            <td class="px-3 py-2">${u.balance || ""}</td>
            <td class="px-3 py-2">${u.account || ""}</td>
            <td class="px-3 py-2">${u.wid || ""}</td>
            <td class="px-3 py-2">${u.referredby || ""}</td>
            <td class="px-3 py-2">${u.email || ""}</td>
            <td class="px-3 py-2">${u.password || ""}</td>
            <td class="px-3 py-2">
              <button class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded edit-btn">Edit</button>
              <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded delete-btn">Delete</button>
            </td>`;
          usersContainer.appendChild(tr);

          tr.querySelector(".delete-btn").addEventListener("click", () => remove(ref(db, "users/" + key)).then(fetchUsers));
        }
      } else usersContainer.innerHTML = `<tr><td colspan="11" class="text-center py-2">No users found</td></tr>`;
    }
    fetchUsers();
    searchInput.addEventListener("input", e => {
      const val = e.target.value.toLowerCase();
      [...usersContainer.children].forEach(row => {
        const name = row.children[1]?.textContent.toLowerCase() || "";
        row.style.display = name.includes(val) ? "" : "none";
      });
    });

    // Packages
    const usernameSelect = document.getElementById("username");
    const packageForm = document.getElementById("packageForm");
    const statusMessage = document.getElementById("statusMessage");
    const loadingBar = document.getElementById("loadingBar");
    const packageTableBody = document.querySelector("#packagesTable tbody");

    async function loadUsernames() {
      const snapshot = await get(ref(db, "users"));
      if (snapshot.exists()) {
        usernameSelect.innerHTML = '<option value="" disabled selected>Select a username</option>';
        const users = snapshot.val();
        for (const key in users) {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = key;
          usernameSelect.appendChild(opt);
        }
      }
    }

    async function loadPackages() {
      const snapshot = await get(ref(db, "packages"));
      packageTableBody.innerHTML = "";
      if (snapshot.exists()) {
        const data = snapshot.val();
        for (const user in data) {
          for (const time in data[user]) {
            const pkg = data[user][time];
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="px-3 py-2">${user}</td>
              <td class="px-3 py-2">${pkg.packageName}</td>
              <td class="px-3 py-2">${pkg.dailyEarnings}</td>
              <td class="px-3 py-2">${pkg.date}</td>
              <td class="px-3 py-2">${pkg.timeString}</td>
              <td class="px-3 py-2"><button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded delete-btn">Delete</button></td>`;
            tr.querySelector(".delete-btn").addEventListener("click", () => {
              remove(ref(db, `packages/${user}/${time}`)).then(loadPackages);
            });
            packageTableBody.appendChild(tr);
          }
        }
      }
    }

    packageForm.addEventListener("submit", async e => {
      e.preventDefault();
      const username = usernameSelect.value;
      const packageName = document.getElementById("packageName").value;
      const dailyEarnings = parseFloat(document.getElementById("dailyEarnings").value);
      if (!username || isNaN(dailyEarnings)) return;
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      const date = now.toISOString().split("T")[0];
      await set(ref(db, `packages/${username}/${timeString}`), { packageName, dailyEarnings, date, timeString });
      statusMessage.textContent = "Package saved successfully!";
      loadPackages();
      packageForm.reset();
    });

    // Withdrawals
    const unseenTable = document.getElementById("unseenTable");
    const seenTable = document.getElementById("seenTable");
    onValue(ref(db, "withdrawals"), snapshot => {
      unseenTable.innerHTML = seenTable.innerHTML = "";
      if (snapshot.exists()) {
        const data = snapshot.val();
        for (const key in data) {
          const w = data[key];
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="px-3 py-2">${w.username}</td>
            <td class="px-3 py-2">${w.wallet}</td>
            <td class="px-3 py-2">${w.amount}</td>
            <td class="px-3 py-2">${new Date(parseInt(key)).toLocaleString()}</td>`;
          const btn = document.createElement("button");
          if (w.seen) {
            btn.textContent = "Delete";
            btn.className = "bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded";
            btn.onclick = () => remove(ref(db, "withdrawals/" + key));
            const td = document.createElement("td"); td.appendChild(btn);
            row.appendChild(td);
            seenTable.appendChild(row);
          } else {
            btn.textContent = "Mark Seen";
            btn.className = "bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded";
            btn.onclick = () => update(ref(db, "withdrawals/" + key), { seen: true });
            const td = document.createElement("td"); td.appendChild(btn);
            row.appendChild(td);
            unseenTable.appendChild(row);
          }
        }
      }
    });

    // Initialize
    loadUsernames();
    loadPackages();
  </script>
</body>
</html>
