<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dev Page </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://applet.payherokenya.com/cdn/button_sdk.js?v=3.1"></script>

  <style>
    /* Smooth section switching */
    section {
      transition: opacity 0.5s ease, transform 0.4s ease;
    }
    section.hidden {
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      position: absolute;
      width: 100%;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 via-white to-green-100 min-h-screen font-sans flex flex-col">

  <!-- Header -->
  <header class="bg-green-700 text-white py-4 shadow-lg sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 flex flex-wrap justify-between items-center">
      <h1 class="text-xl sm:text-2xl font-bold tracking-tight mb-2 sm:mb-0">üíº 20X and Pasco Access Payment System</h1>

      <!-- Nav Buttons -->
      <div class="flex space-x-2 sm:space-x-4">
        <button id="showPayment" class="bg-white text-green-700 font-semibold px-3 sm:px-5 py-1.5 rounded-lg hover:bg-green-100 transition">
          üí∞ Payment
        </button>
        <button id="showAdmin" class="bg-white text-green-700 font-semibold px-3 sm:px-5 py-1.5 rounded-lg hover:bg-green-100 transition">
          üìä Admin
        </button>
      </div>
    </div>
  </header>

  <!-- Payment Section -->
  <section id="paymentSection" class="flex-grow flex items-center justify-center py-8 sm:py-12 px-4">
    <div class="bg-white shadow-2xl rounded-2xl p-6 sm:p-8 w-full max-w-md mx-auto transition-transform hover:scale-[1.01]">
      <div class="text-center mb-6">
        <h1 class="text-2xl sm:text-3xl font-extrabold text-green-700 tracking-tight">20X and Pasco Access Payment</h1>
        <p class="text-gray-600 mt-2 text-sm sm:text-base">
          Pay <span class="font-semibold text-green-700">KES 400 daily</span> to keep your access active.
        </p>
      </div>

      <div class="space-y-4">
        <div>
          <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
          <input id="phone" type="text" placeholder="07XXXXXXXX"
            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none text-gray-800">
        </div>

        <div>
          <label for="amount" class="block text-sm font-medium text-gray-700">Amount (KES)</label>
          <input id="amount" type="number" placeholder="Minimum 400"
            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none text-gray-800">
        </div>

        <button id="payBtn"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2.5 rounded-lg transition duration-200 ease-in-out shadow-md">
          Proceed to Pay
        </button>
      </div>

      <div id="payHero" class="mt-6"></div>

      <div class="mt-5 text-center">
        <p id="status" class="text-gray-600 text-sm font-medium"></p>
        <div id="loader" class="hidden mt-3 flex justify-center">
          <div class="w-6 h-6 border-2 border-green-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin Section -->
  <section id="adminSection" class="hidden py-10 px-4 sm:px-6 flex-grow container mx-auto">
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
      <h2 class="text-lg sm:text-xl font-semibold text-green-700 mb-2">üíµ Total Payments Summary</h2>
      <p id="totalAmount" class="text-3xl font-bold text-gray-800">KES 0</p>
      <p id="lastUpdated" class="text-sm text-gray-500 mt-1">Last Updated: --</p>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-lg sm:text-xl font-semibold text-green-700 mb-4">üìú Payment Logs</h2>
      <div class="overflow-x-auto rounded-lg border border-gray-200">
        <table class="min-w-full text-sm text-left">
          <thead class="bg-green-100 text-green-800 text-xs uppercase font-semibold">
            <tr>
              <th class="py-3 px-4">Date</th>
              <th class="py-3 px-4">Phone</th>
              <th class="py-3 px-4">Amount (KES)</th>
              <th class="py-3 px-4">Reference</th>
            </tr>
          </thead>
          <tbody id="logsTable" class="divide-y divide-gray-100 text-gray-700">
            <tr><td colspan="4" class="py-4 text-center text-gray-500">Loading payments...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-green-700 text-white text-center py-3 text-sm mt-auto">
    <p>&copy; Access Payment System. All rights reserved.</p>
  </footer>

  <!-- JavaScript (same functionality, untouched) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBtB199eH6fONCftI_B6IDP80_0Tv2dFN8",
      authDomain: "m-sales-45b35.firebaseapp.com",
      databaseURL: "https://m-sales-45b35-default-rtdb.firebaseio.com",
      projectId: "m-sales-45b35",
      storageBucket: "m-sales-45b35.appspot.com",
      messagingSenderId: "194892525308",
      appId: "1:194892525308:web:c01af3028c85abdb97f179"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const FIXED_ACCESS_CODE = "778899";

    const paymentSection = document.getElementById("paymentSection");
    const adminSection = document.getElementById("adminSection");
    const showPayment = document.getElementById("showPayment");
    const showAdmin = document.getElementById("showAdmin");

    showPayment.addEventListener("click", () => {
      paymentSection.classList.remove("hidden");
      adminSection.classList.add("hidden");
    });

    showAdmin.addEventListener("click", () => {
      adminSection.classList.remove("hidden");
      paymentSection.classList.add("hidden");
    });

    const payBtn = document.getElementById("payBtn");
    const status = document.getElementById("status");
    const loader = document.getElementById("loader");

    window.makePayment = () => {
      const phone = document.getElementById("phone").value.trim();
      const amount = parseFloat(document.getElementById("amount").value.trim());
      if (!phone || !/^07\d{8}$/.test(phone)) {
        status.textContent = "‚ö†Ô∏è Please enter a valid Safaricom phone number.";
        status.classList.add("text-red-600");
        return;
      }
      if (isNaN(amount) || amount < 400) {
        status.textContent = "‚ö†Ô∏è Minimum payment is KES 400.";
        status.classList.add("text-red-600");
        return;
      }
      loader.classList.remove("hidden");
      status.textContent = "Initializing payment...";
      PayHero.init({
        paymentUrl: "https://app.payhero.co.ke/lipwa/1068",
        width: "100%",
        height: "100%",
        containerId: "payHero",
        channelID: 4476,
        amount,
        phone,
        name: phone,
        reference: "daily_" + Date.now(),
        buttonName: `Pay KES ${amount}`,
        buttonColor: "#00a884"
      });
      status.textContent = "Awaiting payment confirmation...";
    };

    payBtn.addEventListener("click", makePayment);

    window.addEventListener("message", async (event) => {
      if (!event.data?.paymentSuccess) return;
      loader.classList.remove("hidden");
      status.textContent = "‚úÖ Payment confirmed. Updating your access...";
      const phone = document.getElementById("phone").value.trim();
      const amount = parseFloat(document.getElementById("amount").value.trim());
      const daysPaid = Math.floor(amount / 400);
      const today = new Date();
      const codeRef = ref(db, "DailyPayments/" + FIXED_ACCESS_CODE);
      const snapshot = await get(codeRef);
      let newExpiry;
      if (snapshot.exists()) {
        const oldExpiry = new Date(snapshot.val().expiry);
        if (oldExpiry > today) {
          oldExpiry.setDate(oldExpiry.getDate() + daysPaid);
          newExpiry = oldExpiry;
        } else {
          newExpiry = new Date(today.setDate(today.getDate() + daysPaid));
        }
      } else {
        newExpiry = new Date(today.setDate(today.getDate() + daysPaid));
      }
      await set(codeRef, {
        code: FIXED_ACCESS_CODE,
        expiry: newExpiry.toISOString(),
        lastPayment: new Date().toISOString(),
        lastAmount: amount,
        lastPhoneUsed: phone,
        topUpDays: daysPaid
      });
      const totalRef = ref(db, "PaymentRecords/Total");
      const totalSnap = await get(totalRef);
      let newTotal = amount;
      if (totalSnap.exists()) newTotal += totalSnap.val().totalAmount || 0;
      await set(totalRef, {
        totalAmount: newTotal,
        lastUpdated: new Date().toISOString()
      });
      const recordRef = ref(db, "PaymentRecords/Logs/" + Date.now());
      await set(recordRef, {
        phone,
        amount,
        date: new Date().toISOString(),
        reference: "daily_" + Date.now(),
      });
      loader.classList.add("hidden");
      status.classList.remove("text-red-600");
      status.classList.add("text-green-700");
      status.textContent = `‚úÖ Payment successful! Access extended until ${newExpiry.toDateString()}`;
      setTimeout(() => {
        adminSection.classList.remove("hidden");
        paymentSection.classList.add("hidden");
      }, 2500);
    });

    const totalAmountEl = document.getElementById("totalAmount");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const logsTable = document.getElementById("logsTable");

    const totalRef = ref(db, "PaymentRecords/Total");
    onValue(totalRef, (snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        totalAmountEl.textContent = "KES " + (data.totalAmount || 0).toLocaleString();
        lastUpdatedEl.textContent = "Last Updated: " + new Date(data.lastUpdated).toLocaleString();
      } else {
        totalAmountEl.textContent = "KES 0";
        lastUpdatedEl.textContent = "Last Updated: --";
      }
    });

    const logsRef = ref(db, "PaymentRecords/Logs");
    onValue(logsRef, (snapshot) => {
      if (!snapshot.exists()) {
        logsTable.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-500">No payment logs yet.</td></tr>`;
        return;
      }
      const logs = snapshot.val();
      const sorted = Object.entries(logs).sort((a, b) => b[0] - a[0]);
      logsTable.innerHTML = sorted.map(([key, log]) => `
        <tr class="hover:bg-green-50 transition">
          <td class="py-2 px-4">${new Date(log.date).toLocaleString()}</td>
          <td class="py-2 px-4">${log.phone}</td>
          <td class="py-2 px-4 font-semibold text-green-700">${log.amount}</td>
          <td class="py-2 px-4 text-sm text-gray-600">${log.reference}</td>
        </tr>
      `).join("");
    });
  </script>

</body>
</html>
